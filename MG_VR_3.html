<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>Сензор + джойстик VR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #lcdText {
      position: absolute;
      top: 20px; left: 20px;
      color: lime;
      background: black;
      font-family: monospace;
      padding: 10px;
      font-size: 20px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div id="lcdText">Разстояние: -- см</div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { VRButton } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js";

    // --- Сцена, камера, рендърер ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.Fog(0x000000, 0.1, 20);

    const camera = new THREE.PerspectiveCamera(
      70,
      window.innerWidth / window.innerHeight,
      0.1,
      100
    );
    camera.position.set(0, 1.6, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    // --- Светлини и под ---
    const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.7);
    dir.position.set(3, 5, 2);
    scene.add(dir);

    const floorGeo = new THREE.CircleGeometry(5, 64);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x202225, roughness: 1 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = 0;
    scene.add(floor);

    const grid = new THREE.GridHelper(10, 20, 0x555555, 0x333333);
    grid.position.y = 0.001;
    scene.add(grid);

    // --- Обекти: сензор, цел (червена топка), LED ---
    const sensor = new THREE.Mesh(
      new THREE.BoxGeometry(0.6, 0.3, 0.3),
      new THREE.MeshStandardMaterial({ color: 0x00ffcc })
    );
    sensor.position.set(0, 1.4, -2);
    scene.add(sensor);

    const targetMat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
    const target = new THREE.Mesh(
      new THREE.SphereGeometry(0.25, 24, 16),
      targetMat
    );
    target.position.set(0, 1.4, -3);
    scene.add(target);

    const ledMat = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
    const led = new THREE.Mesh(
      new THREE.SphereGeometry(0.15, 16, 16),
      ledMat
    );
    led.position.set(0.8, 1.4, -2.5);
    scene.add(led);

    const lcdText = document.getElementById('lcdText');

    // --- Джойстик контрол (контролер 0) ---
    let session = null;

    renderer.xr.addEventListener('sessionstart', () => {
      session = renderer.xr.getSession();
    });

    renderer.xr.addEventListener('sessionend', () => {
      session = null;
    });

    function updateFromJoystick(delta) {
      if (!session) return;
      const inputSources = session.inputSources;
      if (!inputSources || inputSources.length === 0) return;

      // Взимаме първия контролер с gamepad
      let gamepad = null;
      for (const src of inputSources) {
        if (src && src.gamepad && src.gamepad.axes && src.gamepad.axes.length >= 2) {
          gamepad = src.gamepad;
          break;
        }
      }
      if (!gamepad) return;

      // Оси на джойстика (обикновено [0]=ляво/дясно, [1]=напред/назад)
      const axX = gamepad.axes[0] || 0;
      const axY = gamepad.axes[1] || 0;

      const speed = 1.0 * delta; // скорост на движение

      // Движим топката в равнина X/Y пред сензора (Z почти фиксирано на -3)
      target.position.x += axX * speed;
      target.position.y += -axY * speed; // минус, за да е интуитивно

      // Фиксираме Z около -3
      target.position.z = -3;

      // Ограничения да не излиза извън кадър
      target.position.x = THREE.MathUtils.clamp(target.position.x, -1.5, 1.5);
      target.position.y = THREE.MathUtils.clamp(target.position.y, 0.5, 2.2);
    }

    // --- Логика за разстоянието и LED ---
    function updateDistance() {
      const d = sensor.position.distanceTo(target.position); // в "метри"
      const cm = Math.round(d * 100); // условни сантиметри

      lcdText.textContent = `Разстояние: ${cm} см`;

      if (cm < 30) {
        ledMat.color.set(0xff0000);
      } else if (cm < 60) {
        ledMat.color.set(0xffff00);
      } else {
        ledMat.color.set(0x00ff00);
      }
    }

    // --- Анимационен цикъл ---
    let lastTime = 0;
    renderer.setAnimationLoop((time) => {
      const delta = (time - lastTime) / 1000;
      lastTime = time;

      // леко въртене на сензора, за да има движение
      sensor.rotation.y += delta * 0.5;

      updateFromJoystick(delta);
      updateDistance();

      renderer.render(scene, camera);
    });

    // --- Resize ---
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
