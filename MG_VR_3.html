<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <title>Сензор + джойстик VR (минимален)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #lcdText, #joyText {
      position: absolute;
      left: 20px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.8);
      color: #a3e635;
      font-family: monospace;
      font-size: 16px;
      z-index: 10;
    }
    #lcdText { top: 20px; }
    #joyText { top: 60px; color:#38bdf8; }
  </style>
</head>
<body>
  <div id="lcdText">Разстояние: -- см</div>
  <div id="joyText">Joystick: 0.00, 0.00</div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { VRButton } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js";

    const lcdText = document.getElementById('lcdText');
    const joyText = document.getElementById('joyText');

    // --- Сцена, камера, рендърер ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.Fog(0x000000, 0.1, 20);

    const camera = new THREE.PerspectiveCamera(
      70,
      window.innerWidth / window.innerHeight,
      0.1,
      100
    );
    camera.position.set(0, 1.6, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    // --- Светлина и под ---
    const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.7);
    dir.position.set(3, 5, 2);
    scene.add(dir);

    const floorGeo = new THREE.CircleGeometry(5, 64);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x202225, roughness: 1 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = 0;
    scene.add(floor);

    const grid = new THREE.GridHelper(10, 20, 0x555555, 0x333333);
    grid.position.y = 0.001;
    scene.add(grid);

    // --- Обекти: сензор, цел (червена топка), LED ---
    const sensor = new THREE.Mesh(
      new THREE.BoxGeometry(0.6, 0.3, 0.3),
      new THREE.MeshStandardMaterial({ color: 0x00ffcc })
    );
    sensor.position.set(0, 1.4, -2);
    scene.add(sensor);

    const targetMat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
    const target = new THREE.Mesh(
      new THREE.SphereGeometry(0.25, 24, 16),
      targetMat
    );
    target.position.set(0, 1.4, -3);
    scene.add(target);

    const ledMat = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
    const led = new THREE.Mesh(
      new THREE.SphereGeometry(0.15, 16, 16),
      ledMat
    );
    led.position.set(0.8, 1.4, -2.5);
    scene.add(led);

    // --- WebXR session за достъп до джойстика ---
    let xrSession = null;

    renderer.xr.addEventListener('sessionstart', () => {
      xrSession = renderer.xr.getSession();
    });

    renderer.xr.addEventListener('sessionend', () => {
      xrSession = null;
    });

    // --- Четене на джойстика и местене на червената топка ---
    function updateFromJoystick(delta) {
      if (!xrSession) return;

      const inputSources = xrSession.inputSources;
      if (!inputSources || inputSources.length === 0) return;

      // Намираме първия контролер, който има gamepad с оси
      let gamepad = null;
      for (const src of inputSources) {
        if (src && src.gamepad && src.gamepad.axes && src.gamepad.axes.length >= 2) {
          gamepad = src.gamepad;
          break;
        }
      }
      if (!gamepad) return;

      const axX = gamepad.axes[0] || 0;  // ляво/дясно
      const axY = gamepad.axes[1] || 0;  // напред/назад

      joyText.textContent = `Joystick: ${axX.toFixed(2)}, ${axY.toFixed(2)}`;

      const speed = 1.5 * delta; // „скорост“ на движение

      // Движим топката в равнина X/Y, Z фиксирано на -3
      target.position.x += axX * speed;
      target.position.y += -axY * speed; // минус, за да е интуитивно

      target.position.z = -3;

      // Ограничения да не бяга прекалено
      target.position.x = THREE.MathUtils.clamp(target.position.x, -1.5, 1.5);
      target.position.y = THREE.MathUtils.clamp(target.position.y, 0.5, 2.2);
    }

    // --- Разстояние и LED логика ---
    function updateDistance() {
      const d = sensor.position.distanceTo(target.position); // в „метри“
      const cm = Math.round(d * 100); // условни сантиметри

      lcdText.textContent = `Разстояние: ${cm} см`;

      if (cm < 30) {
        ledMat.color.set(0xff0000);
      } else if (cm < 60) {
        ledMat.color.set(0xffff00);
      } else {
        ledMat.color.set(0x00ff00);
      }
    }

    // --- Анимация ---
    let lastTime = 0;
    renderer.setAnimationLoop((time) => {
      const delta = (time - lastTime) / 1000;
      lastTime = time;

      sensor.rotation.y += delta * 0.5;

      updateFromJoystick(delta);
      updateDistance();

      renderer.render(scene, camera);
    });

    // --- Resize ---
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
